---
layout: post
title: APSP 算法
categories: 算法
---

### 1. APSP 

APSP (All-Pairs Shortest Paths) 问题：
* 输入: 有向图 G = (V, E)，带有权重函数 w
* 输出：输出所有的 δ(u, v)，如果 G 包含负权重环路，记录该顶点

可以简单的运行 SSSP 算法 \|V\| 次。但是在包含负权重的图中，Johnson 算法可以把复杂度降低为 `|V|·O(|V|log|V|+|E|)`

方法：
* Idea：在保留最短路径的前提下，让所有边的权重变为非负。例如，让 G 变为 G'，且 G' 中没有负权重，在这个过程中，G 中的最短路径和 G' 中的最短路径要保持一致。如果图中没有负权重，那么可以使用 Dijkstra 算法运行 \|V\| 次来解决 APSP。
* Claim：可以从 G' 中的距离计算出 G 中的距离，且时间复杂度为 `O(|V|(|V|+|E|))`
    - 对于 V' 中的每个顶点 s，从距离中可以计算出最短路径树，时间复杂度为 `O(|V| + |E|)`
    - 这也是 G 中的最短路径树，所以用 DFS 遍历树，可以计算出 G 中的距离
    - 总共花费 `O(|V|(|V|+|E|))`时间
* Claim：如果 G 中包含负权重环路，无法把 G 转变为非负权重图 G'
* Proof：如果一个图为非负权重，那么其最短路径是简单路径。但是在有负权重环路的图中，最短路径不一定是简单路径。无法做到 G 和 G' 中的最短路径保持不变。


### 2. 权重变为非负

如果图 G 有负权重，但是没有负权重环路，如何把权重变为非负：
* Idea：在每条的权重上，增加最小权重的负值，那么得到的所有权重都是非负的
* 上述 idea 不可行，因为，没有保留最短路径不变， G' 中最短路径偏向于选择更少边的路径。
* Idea：给定顶点 v，在所有的出边上加 h，在所有的入边上减少 h
* Claim：在上述的重新赋权重后，最短路径得到了保留
* Proof：
    - v 开始的每条路径权重改变了 h
    - 以 v 结束的每条路径权重改变了 -h
    - 经过 v 的路径权重局部不改变

**potential function h：**把 V 映射到整数

图 G' 此时由 G 创建而来，但是边 (u, v) 的权重 w'(u, v) = w(u, v) + h(u) - h(v)

Claim: 图 G 中的最短路径还是 G' 中的最短路径

Proof：
* G 中路径 π = (v0, ..., vk) 权重为 w(π)。该路径在 G'中的权重是 w(π) + h(v0) - h(vk)
* 从 v0 到 vk 所有的路径都是改变了相同的量，都是 h(v0)-h(vk)
* 所以图 G 中的最短路径还是 G' 中的最短路径

---

找到 potential function：
* 需要满足对于任意的边 (u, v)，w(u,v) + h(u) - h(v) >= 0
* 变形后得到：h(v) <= h(u)+w(u, v)，形式类似于三角不等式
* Idea：选 h(v) = δ(s, v)，那么上述条件可能满足，但是图中可能存在不连通的点，因此 h(v) 不能简单的选为 δ(s, v)
* Idea：增加一个新顶点 s，该顶点有指向任一顶点的出边，且这些出边的权重为 0。通过增加新顶点和权重为 0 的边，避免了图不连通的问题。 h(v) 可以选为 δ(s, v)。

* Claim：如果 δ(s, v) = −∞，那么原始的图中存在负权重环路
* Proof：
    - 在图中增加的新顶点 s 不会添加环路，因为 s 只有出边
    - 如果没有负权重环路，那么 δ(s, v) <= 0，如果 δ(s, v) = −∞，那么原始的图中存在负权重环路

**Johnson's 算法：**
* 从图 G 增加一个顶点 x，x 有权重为 0 的出边连接到每一个顶点，得到图 Gx
* 使用 Bellman-Ford 算法计算 δ(x, v)
* 如果 δ(x, v) = −∞，那么对于该顶点 v：
    - Abort
* 否则：
    - 更改边的权重为 w'(u, v) = w(u, v) + δ(x, u) - δ(x, v)，形成图 G'
    - 对于每个顶点 u：
    - 使用 Dijkstra 算法计算到每个顶点 v 的 δ'(u, v)
    - 图 G 中的距离 δ(u, v) = δ'(u, v) − δ(x, u) + δ(x, v)

运行时间：
`O(|V| * (|V|log|V| + |E|))`
